<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BLOWEARN AGENCIES - Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet"> 
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  
  <style>
    /* -------------------------------------------------------------------------- */
    /* --- CSS HARMONIS√â (Alignement avec index.html) --- */
    /* -------------------------------------------------------------------------- */
    
    /* Variables de Couleurs - Alignement avec index.html */
    :root {
      --color-primary: #4A90E2; /* Bleu √ânergique BLOWEARN */
      --color-secondary: #FFC107; /* Jaune Vif/Or BLOWEARN */
      --color-text-dark: #2C3E50; /* Texte Sombre (lisible) */
      --color-text-light: #ECF0F1; /* Texte Clair */
      --color-bg-light: #FFFFFF; /* Fond de Carte */

      /* NOUVELLES VAR pour DASHBOARD bas√©es sur les couleurs BLOWEARN */
      --primary-color: var(--color-primary); 
      --primary-light: #6DD5FA; /* Base du d√©grad√© */
      --primary-dark: #3773B3; /* Version Dark du primary */
      --secondary-color: var(--color-text-dark); 
      --accent-color: var(--color-secondary); /* Nouvelle accent */
      --background-light: #f5f7fb; 
      --background-dark: #e5e9f0;
      --card-bg: rgba(255, 255, 255, 0.95); /* Fond de carte transparent pour Glassmorphism */
      --text-color: var(--color-text-dark);
      --text-light: #607d8b; /* Couleur de texte plus douce pour light text */
      --success-color: #4CD964;
      --warning-color: #FF9500;
      --danger-color: #FF3B30;
      --shadow: 0 15px 40px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.8);
      --transition: all 0.3s ease;
      --badge-active: #4CD964;
      --badge-pending: #FF9500;
      --badge-inactive: #FF3B30;
    }

    .dark-mode {
      /* Conservation du mode sombre pour la fonctionnalit√© */
      --primary-color: #5e81ac;
      --primary-light: #81a1c1;
      --primary-dark: #4c566a;
      --secondary-color: #d8dee9;
      --accent-color: #88c0d0;
      --background-light: #2e3440;
      --background-dark: #3b4252;
      --card-bg: #434c5e;
      --text-color: #eceff4;
      --text-light: #d8dee9;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      --badge-active: #2ecc71;
      --badge-pending: #f1c40f;
      --badge-inactive: #e74c3c;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      /* Police principale Montserrat de index.html */
      font-family: 'Montserrat', sans-serif; 
      transition: var(--transition);
    }
    
    /* Styles de base et Arri√®re-plan de index.html */
    body {
      background: linear-gradient(135deg, #6DD5FA 0%, #FF7582 100%); 
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      visibility: hidden; 
      opacity: 0;
      transition: opacity 0.5s ease, visibility 0.5s ease;
      position: relative;
      overflow-x: hidden;
    }

    /* Effet de bulles anim√©es en arri√®re-plan (de index.html) */
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.4) 0%, transparent 25%),
        radial-gradient(circle at 80% 10%, rgba(255, 255, 255, 0.3) 0%, transparent 25%),
        radial-gradient(circle at 40% 80%, rgba(255, 255, 255, 0.3) 0%, transparent 25%),
        radial-gradient(circle at 90% 90%, rgba(255, 255, 255, 0.2) 0%, transparent 25%);
      animation: float 20s ease-in-out infinite;
      z-index: -1;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-15px) scale(1.02); }
    }

    /* Loader */
    .loader-container {
      background: linear-gradient(135deg, #6DD5FA 0%, #FF7582 100%);
      /* ... reste du style ... */
    }

    .loader {
      background: conic-gradient(#0000 10%, var(--primary-color));
      /* ... reste du style ... */
    }

    /* Header styles - Align√© sur la carte de index.html */
    .header {
      background: var(--card-bg); /* Fond glassmorphism */
      backdrop-filter: blur(15px); /* Blur de index.html */
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); 
      border-bottom: 1px solid rgba(255,255,255,0.7);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    /* Logo - Style d√©grad√© et Poppins de index.html */
    .logo {
        font-size: 2.2rem;
        font-weight: 700;
        color: var(--color-text-light);
        display: flex;
        align-items: center;
        font-family: 'Poppins', sans-serif;
        text-transform: uppercase;
        letter-spacing: 2px;
        text-shadow: 0 4px 10px rgba(0,0,0,0.3);
        /* Nouveau d√©grad√© pour le texte du titre */
        background: linear-gradient(45deg, var(--color-primary) 0%, var(--color-secondary) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: logoGlow 3s ease-in-out infinite alternate;
    }
    
    @keyframes logoGlow {
      from { filter: drop-shadow(0 0 5px rgba(74, 144, 226, 0.5)); }
      to { filter: drop-shadow(0 0 15px rgba(255, 193, 7, 0.7)); }
    }
    
    /* Styles pour le badge dans le logo (de index.html) */
    .badge-container {
      position: relative;
      margin-right: 15px;
      height: 45px;
      width: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border-radius: 50%;
      box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
      animation: badgeRotate 8s linear infinite;
      border: 1px solid rgba(255, 255, 255, 0.4);
    }
    
    @keyframes badgeRotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .badge {
      color: var(--color-secondary);
      font-size: 1.4rem;
      z-index: 2;
      text-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    
    /* Sidebar - Style Glassmorphism de index.html */
    .sidebar {
      width: 280px;
      background: rgba(255, 255, 255, 0.9); 
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-right: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: 5px 0 15px rgba(0, 0, 0, 0.05);
      /* ... reste du style ... */
    }

    /* Menu Item - La couleur d'accent est le bleu primaire */
    .menu-item:hover, .menu-item.active {
      border-left-color: var(--primary-color);
      color: var(--primary-color);
    }

    /* Banni√®re - Style carte de index.html + D√©grad√© BLOWEARN */
    .banner {
      background: linear-gradient(135deg, var(--color-primary) 0%, #3773B3 100%); 
      border-radius: 18px; /* Rayon de index.html */
      box-shadow: var(--shadow); 
      margin-bottom: 30px;
      color: white;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.7);
    }

    .username-highlight {
      font-family: 'Pacifico', cursive;
      color: var(--color-secondary); /* Jaune secondaire */
      /* ... reste du style ... */
    }

    /* Small stats cards - Changement de forme et de couleur */
    .small-stat-card {
      background: var(--card-bg); /* Fond blanc */
      border-radius: 18px; /* Rayon de index.html */
      box-shadow: var(--shadow); /* Ombre de index.html */
      color: var(--text-color);
      border: 1px solid rgba(255,255,255,0.7);
      
      /* D√©sactiver les transformations sp√©cifiques et les animations de vague */
      transform: none; 
      animation: fadeInUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      animation-delay: var(--delay, 0s);
    }

    .small-stat-card:nth-child(2) {
      background: var(--card-bg);
      animation-delay: 0.1s;
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(40px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .small-stat-card:hover {
      transform: translateY(-5px); /* Animation de survol de index.html */
      box-shadow: 0 20px 45px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.8);
      animation-play-state: running; 
    }

    .small-stat-card::after {
        content: none; /* Supprimer l'effet radial */
    }

    /* Ajuster le texte des small-stat-cards (supprimer la transformation inverse) */
    .small-stat-title,
    .small-stat-value {
      transform: none;
      color: var(--text-color);
      font-weight: 600;
    }
    .small-stat-value {
        color: var(--primary-color);
        font-size: 1.5rem;
    }

    /* Large stats cards - Nouveau design (Barre sup√©rieure) */
    .large-stat-card, .medium-stat-card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 25px;
      box-shadow: var(--shadow);
      color: var(--text-color);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.7);
      animation: fadeInUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    /* Nouvelle barre de couleur sup√©rieure (comme sur index.html) */
    .large-stat-card::before, .medium-stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px; 
        background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
        border-radius: 18px 18px 0 0;
        z-index: 3;
        animation: none; /* D√©sactiver l'ancienne animation de vague */
        transform: none; 
        width: 100%;
    }

    .large-stat-card:hover, .medium-stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
    }
    
    /* Mettre √† jour le texte des cartes pour les nouvelles couleurs */
    .large-stat-title, .medium-stat-title {
      color: var(--text-color);
      font-weight: 600;
    }
    .large-stat-value, .medium-stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-color);
    }

    .large-stat-icon, .medium-stat-icon {
      font-size: 2rem;
      color: var(--accent-color);
      opacity: 1;
    }

    /* Gain Stat Cards - Style carte + barre lat√©rale */
    .gain-stat-card {
      background: var(--card-bg);
      border-radius: 18px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.7);
      color: var(--text-color);
      height: auto;
      padding: 15px;
      border-left: 4px solid var(--primary-color); /* Nouvelle barre de couleur √† gauche */
      transition: all 0.4s ease;
      animation: none !important; /* D√©sactiver les animations shake/bounce */
    }
    .gain-stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    .gain-stat-value {
        color: var(--primary-color);
    }

    /* Sections diverses - Utiliser le style de carte unifi√© */
    .user-info-section, .task-calendar, .fidelity-section {
        background: var(--card-bg);
        border-radius: 18px; 
        box-shadow: var(--shadow);
        border: 1px solid rgba(255,255,255,0.7);
        padding: 30px;
    }
    .section-title {
        color: var(--secondary-color);
        border-bottom: 2px solid var(--accent-color);
        padding-bottom: 5px;
    }
    
    /* Boutons sociaux - Garder les couleurs mais en forme de carte */
    .social-btn {
        border-radius: 12px;
        box-shadow: var(--shadow);
    }

    /* Le reste du CSS du dashboard est conserv√© intact pour ne pas affecter le JS */
  </style>
</head>
<body>
  <div id="loader" class="loader-container">
    <div class="loader"></div>
  </div>

  <header class="header">
    <div class="logo">
      <div class="badge-container">
        <i class="fas fa-crown badge"></i>
      </div>
      <span>BLOWEARN</span>
    </div>
    <div class="header-controls">
      <button class="language-selector" id="languageSelector">
        <i class="fas fa-globe"></i>
        FR
      </button>
      <button class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon"></i>
      </button>
      <div class="user-profile" id="userProfile">
        <div class="avatar" id="userAvatar">U</div>
        <i class="fas fa-chevron-down" id="dropdownArrow"></i>
        <div class="profile-dropdown" id="profileDropdown">
          <div class="theme-toggle" id="themeToggleDropdown">
              <i class="fas fa-moon"></i>
              <span>Mode nuit</span>
          </div>
          <button class="theme-toggle" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i>
            <span>D√©connexion</span>
          </button>
        </div>
      </div>
      <button class="hamburger-btn" id="hamburgerBtn">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
      </button>
    </div>
  </header>

  <div class="main-container">
    <div class="overlay" id="overlay"></div>
    <div class="sidebar" id="sidebar">
      <div class="welcome-section">
        <div class="welcome-text">Dashboard >> BLOWEARN AGENCIES</div>
        <div class="username" id="sidebarUsername">Utilisateur</div>
      </div>
      
      <div class="menu-category">PRINCIPAL</div>
      <a href="dashboard.html" class="menu-item active">
        <i class="fas fa-home"></i> <span>Tableau de bord</span> <span class="menu-badge badge-active">‚òë</span>
      </a>
      <a href="depot.html" class="menu-item">
        <i class="fas fa-wallet"></i> <span>Fonds / D√©p√¥t</span> <span class="menu-badge badge-inactive">‚òê</span>
      </a>
      <a href="bonus_bienvenue.html" class="menu-item">
        <i class="fas fa-gift"></i> <span>T√¢che d'activation</span> <span class="menu-badge badge-inactive">‚òí</span>
      </a>
      
      <div class="menu-category">COMPTES</div>
      <a href="retrait.html" class="menu-item">
        <i class="fas fa-money-bill-wave"></i> <span>Gains / Retrait</span> <span class="menu-badge badge-inactive">‚òê</span>
      </a>
      <a href="equipe.html" class="menu-item">
        <i class="fas fa-users"></i> <span>Mon R√©seau</span> <span class="menu-badge badge-inactive">‚òí</span>
      </a>
      
      <div class="menu-category">SP√âCIAL</div>
      <a href="love_earn.html" class="menu-item">
        <i class="fas fa-heart"></i> <span>Affiliation I</span> <span class="menu-badge badge-inactive">‚òê</span>
      </a>
      <a href="social_boost.html" class="menu-item">
        <i class="fas fa-rocket"></i> <span>Affiliation II</span> <span class="menu-badge badge-inactive">‚òê</span>
      </a>
      <a href="challenge_reward.html" class="menu-item">
        <i class="fas fa-medal"></i> <span>T√¢ches Exclusives</span> <span class="menu-badge badge-inactive">‚òê</span>
      </a>
      
      <div class="menu-category">PRODUIT / TACHE</div>
      <a href="whatsapp_earn.html" class="menu-item">
        <i class="fab fa-whatsapp"></i> <span>Pub. WhatsApp</span> <span class="menu-badge badge-inactive">‚òê</span>
      </a>
      <a href="trivia_earn.html" class="menu-item">
        <i class="fas fa-brain"></i> <span>Quizz - Gains</span> <span class="menu-badge badge-inactive">‚òê</span>
      </a>
      <a href="publicite_earn.html" class="menu-item">
        <i class="fas fa-bullhorn"></i> <span>Pub. M√©dia - Gains</span> <span class="menu-badge badge-inactive">‚òê</span>
      </a>
      <a href="tiktok_earn.html" class="menu-item">
        <i class="fab fa-tiktok"></i> <span>R√©seaux Sociaux</span> <span class="menu-badge badge-inactive">‚òê</span>
      </a>
      <a href="youtube_earn.html" class="menu-item">
        <i class="fab fa-youtube"></i> <span>Divers</span> <span class="menu-badge badge-inactive">‚òê</span>
      </a>
      <a href="instagram_earn.html" class="menu-item">
        <i class="fab fa-instagram"></i> <span>Parrainage Avanc√©</span> <span class="menu-badge badge-inactive">‚òê</span>
      </a>
      <a href="depot_solde.html" class="menu-item">
        <i class="fas fa-credit-card"></i> <span>Cl√© de Service</span> <span class="menu-badge badge-inactive">‚òê</span>
      </a>

    </div>

    <div class="content">
      <h1 class="page-title"><i class="fas fa-chart-line"></i> Tableau de Bord Principal</h1>

      <div class="banner" id="welcomeBanner">
        <div class="banner-title" id="welcomeTitle">
          Pr√™t √† gagner avec <span class="username-highlight" id="bannerUsername"></span> ?
        </div>
        <div class="banner-text" id="welcomeMessage">
          BLOWEARN AGENCIES vous offre des outils pour exploser vos revenus.
        </div>
        <a href="#taches" class="banner-link">D√©couvrir les t√¢ches</a>
      </div>

      <div class="small-stats">
        <div class="small-stat-card" id="depense-card" style="--delay:0s">
          <div class="small-stat-title">
            <i class="fas fa-file-invoice arrow-icon"></i> Fonds D√©pos√©s: 
          </div>
          <div class="small-stat-value">XAF 0</div>
        </div>
        <div class="small-stat-card" id="profit-card" style="--delay:0.1s">
          <div class="small-stat-title">
            <i class="fas fa-arrow-up arrow-icon"></i> Revenus Totaux: 
          </div>
          <div class="small-stat-value">XAF 0</div>
        </div>
      </div>

      <div class="stats-group-2">
        <div class="large-stat-card" id="solde-card">
          <div class="large-stat-title">
            <i class="fas fa-piggy-bank large-stat-icon"></i> SOLDE DISPONIBLE
          </div>
          <div class="large-stat-value">XAF 0</div>
          <div class="stat-change"> <span>Vol:(0%)</span> </div>
        </div>
        <div class="medium-stat-card" id="retire-card">
          <div class="medium-stat-title">
            <i class="fas fa-download medium-stat-icon"></i> Montant Retir√©
          </div>
          <div class="medium-stat-value">XAF 0</div>
          <div class="stat-change"> <span>Vol:(0%)</span> </div>
        </div>
        <div class="medium-stat-card" id="parrainage-card">
          <div class="medium-stat-title">
            <i class="fas fa-users medium-stat-icon"></i> Gains d'Affiliation
          </div>
          <div class="medium-stat-value">XAF 0</div>
          <div class="stat-change"> <span>Vol:(0%)</span> </div>
        </div>
        <div class="medium-stat-card" id="bonus-agent-card">
          <div class="medium-stat-title">
            <i class="fas fa-gift medium-stat-icon"></i> Bonus Activit√©
          </div>
          <div class="medium-stat-value">XAF 0</div>
          <div class="stat-change"> <span>Vol:(0%)</span> </div>
        </div>
      </div>

      <div class="fidelity-section">
        <h2 class="section-title">CL√â D'ACTIVATION</h2>
        <p>Votre cl√© unique est n√©cessaire pour les transactions et l'acc√®s aux services VIP.</p>
        <div class="fidelity-key" id="referralLinkContainer">
          <div class="key-icon"><i class="fas fa-key"></i></div>
          <div class="key-text" id="referralLink">Chargement de la cl√©...</div>
          <div class="key-buttons">
            <button class="copy-key-btn" id="copyKeyBtn"><i class="fas fa-copy"></i> Copier</button>
            <button class="send-key-btn" id="sendKeyBtn"><i class="fas fa-share-alt"></i> Partager</button>
          </div>
        </div>
      </div>
      
      <h2 class="section-title" id="taches" style="margin-top: 30px; margin-bottom: 20px;">GAINS PAR T√ÇCHE</h2>

      <div class="gain-stats">
        <div class="gain-stat-card" id="whatsapp-gains">
          <div class="gain-stat-title">WhatsApp Pub.</div>
          <div class="gain-stat-value">XAF 0</div>
        </div>
        <div class="gain-stat-card" id="trivia-gains">
          <div class="gain-stat-title">Quizz - Trivia</div>
          <div class="gain-stat-value">XAF 0</div>
        </div>
        <div class="gain-stat-card" id="publicite-gains">
          <div class="gain-stat-title">Pub. M√©dia</div>
          <div class="gain-stat-value">XAF 0</div>
        </div>
        <div class="gain-stat-card" id="tiktok-gains">
          <div class="gain-stat-title">R√©seaux Sociaux</div>
          <div class="gain-stat-value">XAF 0</div>
        </div>
        <div class="gain-stat-card" id="youtube-gains">
          <div class="gain-stat-title">Divers</div>
          <div class="gain-stat-value">XAF 0</div>
        </div>
        <div class="gain-stat-card" id="instagram-gains">
            <div class="gain-stat-title">Parrainage Avanc√©</div>
            <div class="gain-stat-value">XAF 0</div>
        </div>
        <div class="gain-stat-card" id="depot-solde">
            <div class="gain-stat-title">Cl√© de Service</div>
            <div class="gain-stat-value">XAF 0</div>
        </div>
      </div>
      
      <div class="social-section">
        <h2 class="section-title">REJOIGNEZ NOTRE COMMUNAUT√â</h2>
        <p>Suivez les derni√®res nouvelles et annonces sur nos plateformes officielles.</p>
        <div class="social-links">
          <a href="#" class="social-btn whatsapp" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a>
          <a href="#" class="social-btn facebook" target="_blank"><i class="fab fa-facebook-f"></i> Facebook</a>
          <a href="#" class="social-btn twitter" target="_blank"><i class="fab fa-twitter"></i> Twitter</a>
          <a href="#" class="social-btn telegram" target="_blank"><i class="fab fa-telegram-plane"></i> Telegram</a>
        </div>
      </div>

      <div class="user-info-section">
        <h2 class="section-title">MON PROFIL BLOWEARN</h2>
        <div class="user-info-grid">
          <div class="info-item">
            <div class="info-label">Nom d'utilisateur</div>
            <div class="info-value" id="info-username">Chargement...</div>
          </div>
          <div class="info-item">
            <div class="info-label">Email</div>
            <div class="info-value" id="info-email">Chargement...</div>
          </div>
          <div class="info-item">
            <div class="info-label">T√©l√©phone</div>
            <div class="info-value" id="info-phone">Chargement...</div>
          </div>
          <div class="info-item">
            <div class="info-label">Pays</div>
            <div class="info-value" id="info-country">Chargement...</div>
          </div>
          <div class="info-item">
            <div class="info-label">Parrain</div>
            <div class="info-value" id="info-parrain">Chargement...</div>
          </div>
          <div class="info-item">
            <div class="info-label">Filleuls Actifs</div>
            <div class="info-value" id="info-parrainage">Chargement...</div>
          </div>
        </div>
      </div>

      <div class="task-calendar">
        <h2 class="section-title">ACTIVIT√âS R√âCENTES</h2>
        <div class="calendar-header">
          <div class="calendar-month" id="calendarMonth">Septembre 2025</div>
          <div class="calendar-nav">
            <div class="nav-btn" id="prevMonth">
              <i class="fas fa-chevron-left"></i>
            </div>
            <div class="nav-btn" id="nextMonth">
              <i class="fas fa-chevron-right"></i>
            </div>
          </div>
        </div>
        <div class="calendar-days">
          <div class="day-header">Lun</div>
          <div class="day-header">Mar</div>
          <div class="day-header">Mer</div>
          <div class="day-header">Jeu</div>
          <div class="day-header">Ven</div>
          <div class="day-header">Sam</div>
          <div class="day-header">Dim</div>
        </div>
        <div class="calendar-grid" id="calendarGrid">
          </div>

        <h3 class="section-title" style="margin-top: 30px;">Historique des Transactions</h3>
        <table class="task-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Description</th>
              <th>Montant</th>
              <th>Statut</th>
            </tr>
          </thead>
          <tbody id="taskTableBody">
            <tr>
                <td colspan="4" style="text-align: center; color: var(--text-light);">
                    Chargement des donn√©es...
                </td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <div class="notification-container" id="notificationContainer"></div>
  
  <script>
    // Initialisation de Firebase
    const firebaseConfig = {
      // Les configs de votre application sont ici.
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // R√©f√©rences aux √©l√©ments du DOM (IDs CONSERV√âS)
    const sidebar = document.getElementById('sidebar');
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const overlay = document.getElementById('overlay');
    const userProfile = document.getElementById('userProfile');
    const profileDropdown = document.getElementById('profileDropdown');
    const logoutBtn = document.getElementById('logoutBtn');
    const themeToggle = document.getElementById('themeToggle');
    const themeToggleDropdown = document.getElementById('themeToggleDropdown');
    const calendarGrid = document.getElementById('calendarGrid');
    const calendarMonth = document.getElementById('calendarMonth');
    const prevMonth = document.getElementById('prevMonth');
    const nextMonth = document.getElementById('nextMonth');
    const referralLink = document.getElementById('referralLink');
    const copyKeyBtn = document.getElementById('copyKeyBtn');
    const sendKeyBtn = document.getElementById('sendKeyBtn');
    const taskTableBody = document.getElementById('taskTableBody');
    const userAvatar = document.getElementById('userAvatar');
    const infoUsername = document.getElementById('info-username');
    const infoEmail = document.getElementById('info-email');
    const infoPhone = document.getElementById('info-phone');
    const infoCountry = document.getElementById('info-country');
    const infoParrain = document.getElementById('info-parrain');
    const infoParrainage = document.getElementById('info-parrainage');
    const loader = document.getElementById('loader');
    const welcomeBanner = document.getElementById('welcomeBanner');
    const welcomeTitle = document.getElementById('welcomeTitle');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const bannerUsername = document.getElementById('bannerUsername');

    /******** Variables d'√©tat ********/
    let currentDate = new Date();
    let userData = {};
    let currentUser = null;
    const APP_DOMAIN = "https://mulaflowr-agencies.vercel.app";
    const SERVER_URL = "https://mulaflowr-exaucenapopolo2.replit.app";

    /******** UI helpers ********/
    function showNotification(type, title, message, duration = 4000) {
      const container = document.getElementById('notificationContainer');
      if (!container) return;
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      const icon = type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle');
      notification.innerHTML = `
        <i class="fas ${icon}" style="font-size: 1.5rem;"></i>
        <div>
          <strong style="display: block; margin-bottom: 5px;">${title}</strong>
          <span>${message}</span>
        </div>
      `;
      container.appendChild(notification);
      setTimeout(() => {
        notification.style.animation = 'slideIn 0.3s ease reverse forwards';
        setTimeout(() => {
          if (container.contains(notification)) container.removeChild(notification);
        }, 300);
      }, duration);
    }

    function formatNumberSafe(n) {
      if (typeof n !== 'number' || isNaN(n)) return '0';
      return n.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function updateDashboardUI() {
      try {
        // Mise √† jour des Small Stats (CLASSES ET IDs CONSERV√âS)
        if(document.querySelector('#depense-card .small-stat-value')) document.querySelector('#depense-card .small-stat-value').textContent = `XAF ${formatNumberSafe(userData.depense)}`;
        if(document.querySelector('#profit-card .small-stat-value')) document.querySelector('#profit-card .small-stat-value').textContent = `XAF ${formatNumberSafe(userData.profit)}`;

        // Mise √† jour des Large Stats (CLASSES ET IDs CONSERV√âS)
        if(document.querySelector('#solde-card .large-stat-value')) document.querySelector('#solde-card .large-stat-value').textContent = `XAF ${formatNumberSafe(userData.solde)}`;
        if(document.querySelector('#retire-card .medium-stat-value')) document.querySelector('#retire-card .medium-stat-value').textContent = `XAF ${formatNumberSafe(userData.retire)}`;
        if(document.querySelector('#parrainage-card .medium-stat-value')) document.querySelector('#parrainage-card .medium-stat-value').textContent = `XAF ${formatNumberSafe(userData.parrainage)}`;
        if(document.querySelector('#bonus-agent-card .medium-stat-value')) document.querySelector('#bonus-agent-card .medium-stat-value').textContent = `XAF ${formatNumberSafe(userData.bonusAgent)}`;

        // Mise √† jour des Gain Stats (CLASSES ET IDs CONSERV√âS)
        if(document.querySelector('#whatsapp-gains .gain-stat-value')) document.querySelector('#whatsapp-gains .gain-stat-value').textContent = `XAF ${formatNumberSafe(userData.whatsappGains)}`;
        if(document.querySelector('#trivia-gains .gain-stat-value')) document.querySelector('#trivia-gains .gain-stat-value').textContent = `XAF ${formatNumberSafe(userData.triviaGains)}`;
        if(document.querySelector('#publicite-gains .gain-stat-value')) document.querySelector('#publicite-gains .gain-stat-value').textContent = `XAF ${formatNumberSafe(userData.publiciteGains)}`;
        if(document.querySelector('#tiktok-gains .gain-stat-value')) document.querySelector('#tiktok-gains .gain-stat-value').textContent = `XAF ${formatNumberSafe(userData.tiktokGains)}`;
        if(document.querySelector('#youtube-gains .gain-stat-value')) document.querySelector('#youtube-gains .gain-stat-value').textContent = `XAF ${formatNumberSafe(userData.youtubeGains)}`;
        // NOUVEAU: Mise √† jour du gain Instagram
        if(document.querySelector('#instagram-gains .gain-stat-value')) document.querySelector('#instagram-gains .gain-stat-value').textContent = `XAF ${formatNumberSafe(userData.instagramGains)}`;
        if(document.querySelector('#depot-solde .gain-stat-value')) document.querySelector('#depot-solde .gain-stat-value').textContent = `XAF ${formatNumberSafe(userData.depotSolde)}`;
      } catch (err) {
        console.error('Erreur updateDashboardUI', err);
      }
    }

    function updateUserInfoUI(user, dbData) {
      const displayName = userData.displayName || (user.email ? user.email.split('@')[0] : 'Utilisateur');

      // IDs CONSERV√âS
      if(bannerUsername) bannerUsername.textContent = displayName;
      if(document.getElementById('sidebarUsername')) document.getElementById('sidebarUsername').textContent = displayName;
      if(infoUsername) infoUsername.textContent = displayName;
      if(infoEmail) infoEmail.textContent = user.email || 'N/A';
      if(infoPhone) infoPhone.textContent = dbData.phone || 'N/A';
      if(infoCountry) infoCountry.textContent = dbData.country || 'N/A';
      if(infoParrain) infoParrain.textContent = dbData.parrain || 'Aucun';
      if(infoParrainage) infoParrainage.textContent = `${userData.activeReferrals} Filleul(s)`;
      if (userAvatar) userAvatar.textContent = displayName.charAt(0).toUpperCase();

      const userStatus = (dbData.status || dbData.statut || '').toString().toLowerCase();
      // Affichage des notifications d'√©tat
      if (userStatus === 'pending_payment') {
        showNotification('info', 'Action requise', 'Veuillez finaliser votre paiement pour activer votre compte.');
      } else if (userStatus === 'active' && !userData.referralProcessed) {
        showNotification('info', 'Parrainage en cours', 'Votre paiement a √©t√© d√©tect√©. Distribution des gains en cours...');
      } else if (userStatus === 'active' && userData.referralProcessed) {
        showNotification('success', 'Bienvenue !', `Content de vous revoir, ${userData.displayName || 'ami'} !`);
      }
      updateDashboardUI();
      // Le reste des mises √† jour...
    }

    function updateCalendar() {
      if (!calendarGrid || !calendarMonth) return;
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const monthNames = ["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];
      // ID 'calendarMonth' CONSERV√â
      calendarMonth.textContent = `${monthNames[month]} ${year}`;
      // ID 'calendarGrid' CONSERV√â
      calendarGrid.innerHTML = '';
      
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      let startDay = firstDay === 0 ? 6 : firstDay - 1;

      for (let i=0; i < startDay; i++) {
        calendarGrid.insertAdjacentHTML('beforeend', '<div class="calendar-date"></div>');
      }

      for (let day=1; day <= daysInMonth; day++) {
        const dateCell = document.createElement('div');
        dateCell.className = 'calendar-date';
        dateCell.textContent = day;
        const today = new Date();
        if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dateCell.classList.add('active');
        // REMARQUE: La ligne ci-dessous ajoute la classe 'has-task' mais le CSS a √©t√© modifi√© pour masquer l'affichage du point.
        if (Math.random() > 0.7) dateCell.classList.add('has-task'); 
        calendarGrid.appendChild(dateCell);
      }
    }

    // Gestionnaires d'√©v√©nements pour le calendrier (IDs CONSERV√âS)
    if (prevMonth) prevMonth.addEventListener('click', ()=>{ 
      currentDate.setMonth(currentDate.getMonth()-1); updateCalendar(); 
    }); 
    if (nextMonth) nextMonth.addEventListener('click', ()=>{ 
      currentDate.setMonth(currentDate.getMonth()+1); updateCalendar(); 
    });

    // Mettre √† jour l'historique des transactions (ID 'taskTableBody' CONSERV√â)
    function updateTransactionHistory() {
      if (!taskTableBody) return;
      const data = userData.transactions || [];
      if (data.length === 0) {
        taskTableBody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: var(--text-light);">Aucune transaction r√©cente.</td></tr>`;
        return;
      }

      taskTableBody.innerHTML = '';
      data.slice(0, 5).forEach(tx => {
        const date = tx.date ? new Date(tx.date.seconds * 1000).toLocaleDateString('fr-FR') : 'N/A';
        const type = tx.type || 'Transaction';
        const amount = tx.amount ? `XAF ${formatNumberSafe(tx.amount)}` : 'N/A';
        const status = tx.status || 'Termin√©';
        const statusClass = status.toLowerCase() === 'en attente' ? 'status-pending' : (status.toLowerCase() === 'termin√©' ? 'status-success' : 'status-error');

        taskTableBody.innerHTML += `
          <tr>
            <td>${date}</td>
            <td>${type}</td>
            <td>${amount}</td>
            <td><span class="${statusClass}">${status}</span></td>
          </tr>
        `;
      });
    }


    /******** Fonctions de donn√©es ********/
    async function loadUserData() {
      // CODE JS CONSERV√â
      if (!currentUser) return;
      console.log(`Chargement des donn√©es pour UID: ${currentUser.uid}`);
      let doc = await db.collection('users').doc(currentUser.uid).get();
      let userRef = doc.ref;
      let foundViaEmail = false;

      // Si le document UID n'existe pas, essaie de le trouver par email (m√©thode de secours)
      if (!doc.exists && currentUser.email) {
          console.log('Utilisateur non trouv√© par UID, recherche par email...');
          const emailQuery = await db.collection('users').where('email', '==', currentUser.email).limit(1).get();
          if (!emailQuery.empty) {
              doc = emailQuery.docs[0];
              userRef = doc.ref;
              foundViaEmail = true;
              console.log('‚úÖ Utilisateur trouv√© par email:', currentUser.email);
          }
      }

      const defaultReferralEarnings = { level1: 0, level2: 0, level3: 0 };
      let parrainageTotal = 0;
      let activeReferrals = 0;
      let displayName = currentUser.displayName || (currentUser.email ? currentUser.email.split('@')[0] : 'Utilisateur');
      
      if (doc.exists) {
        const data = doc.data() || {};
        const refEarnings = data.referralEarnings || defaultReferralEarnings;
        parrainageTotal = (refEarnings.level1 || 0) + (refEarnings.level2 || 0) + (refEarnings.level3 || 0);
        activeReferrals = Number(data.totalReferrals || 0);
        displayName = data.displayName || displayName;
        
        // Toutes les propri√©t√©s de 'userData' CONSERV√âES (tr√®s important pour le JS)
        userData = {
          depense: Number(data.depense || data.debit || 0),
          profit: Number(data.profit || data.revenue || 0),
          solde: Number(data.solde || data.balance || 0),
          retire: Number(data.retire || data.withdrawn || 0),
          parrainage: parrainageTotal,
          bonusAgent: Number(data.bonusAgent || data.agentBonus || 0),
          whatsappGains: Number(data.whatsappGains || 0),
          triviaGains: Number(data.triviaGains || 0),
          publiciteGains: Number(data.publiciteGains || 0),
          tiktokGains: Number(data.tiktokGains || 0),
          youtubeGains: Number(data.youtubeGains || 0),
          instagramGains: Number(data.instagramGains || 0), // Nouveau Champ
          depotSolde: Number(data.depotSolde || 0), // Nouveau Champ
          status: data.status || data.statut || 'pending',
          displayName: displayName,
          parrain: data.parrain || 'Aucun',
          country: data.country || 'N/A',
          phone: data.phone || 'N/A',
          referralId: data.referralId || (foundViaEmail ? doc.id : currentUser.uid),
          activeReferrals: activeReferrals,
          transactions: data.transactions || [],
          theme: data.theme || 'light',
          referralProcessed: !!data.referralProcessed // Champ de suivi du paiement
        };
        console.log('‚úÖ Donn√©es utilisateur charg√©es:', userData);

        // Si l'utilisateur a √©t√© trouv√© par email, mettre √† jour le document avec l'UID
        if (foundViaEmail && doc.id !== currentUser.uid) {
            console.log(`Mise √† jour de l'UID dans Firestore de ${doc.id} √† ${currentUser.uid}`);
            await userRef.update({ uid: currentUser.uid });
        }
      } else {
        console.warn('‚ö†Ô∏è Document utilisateur Firestore non trouv√©, utilisant les valeurs par d√©faut.');
        // Initialiser avec des valeurs par d√©faut si l'utilisateur est dans Auth mais pas Firestore
        userData = {
            depense: 0, profit: 0, solde: 0, retire: 0, parrainage: 0, bonusAgent: 0, 
            whatsappGains: 0, triviaGains: 0, publiciteGains: 0, tiktokGains: 0, 
            youtubeGains: 0, instagramGains: 0, depotSolde: 0, status: 'pending', displayName: displayName, 
            parrain: 'Aucun', country: 'N/A', phone: 'N/A', referralId: currentUser.uid, 
            activeReferrals: 0, transactions: [], theme: 'light', referralProcessed: false
        };
      }
    }

    async function toggleTheme() {
      // CODE JS CONSERV√â
      const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
      document.body.classList.toggle('dark-mode');
      
      const isDarkMode = newTheme === 'dark';
      if (themeToggle) themeToggle.innerHTML = isDarkMode 
          ? '<i class="fas fa-sun"></i>' 
          : '<i class="fas fa-moon"></i>';
      if (themeToggleDropdown) themeToggleDropdown.innerHTML = isDarkMode 
          ? '<i class="fas fa-sun"></i><span>Mode jour</span>' 
          : '<i class="fas fa-moon"></i><span>Mode nuit</span>';

      try {
        await db.collection('users').doc(currentUser.uid).update({ theme: newTheme });
        userData.theme = newTheme;
      } catch (err) {
        console.error("Erreur lors de la sauvegarde du th√®me:", err);
      }
    }

    function startStatusWatcherAndTriggerProcessing() {
      // CODE JS CONSERV√â
      if (!currentUser) return;
      try {
        const userDocRef = db.collection('users').doc(currentUser.uid);
        userDocRef.onSnapshot(async (snap) => {
          if (!snap.exists) return;
          const d = snap.data();
          const status = (d.status || d.statut || '').toString().toLowerCase();
          const alreadyProcessed = !!d.referralProcessed;

          if (status === 'active' && !alreadyProcessed) {
            showNotification('info', 'Parrainage', 'Paiement d√©tect√© ‚Äî distribution en cours...');
            try {
              const idToken = await currentUser.getIdToken();
              const resp = await fetch(`${SERVER_URL}/api/process-referral-on-paid`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${idToken}`
                },
                body: JSON.stringify({ userDocId: currentUser.uid })
              });
              const json = await resp.json().catch(()=>({}));

              if (resp.ok && json && json.ok) {
                showNotification('success', 'Parrainage', 'Gains partag√©s aux parrains.');
                // Recharger les donn√©es apr√®s le traitement
                await loadUserData(); 
                updateDashboardUI();
                updateUserInfoUI(currentUser, userData);
              } else {
                console.error('Erreur process-referral-on-paid:', json);
                showNotification('error', 'Parrainage', (json && json.error) ? json.error : 'Erreur lors du partage des gains.');
              }
            } catch (err) {
              console.error('Erreur lors du fetch process-referral-on-paid:', err);
              showNotification('error', 'Parrainage', 'Erreur de connexion au serveur.');
            }
          }
        });
      } catch (err) {
        console.error('Erreur startStatusWatcher:', err);
      }
    }


    /******** Gestion des √©v√©nements ********/
    if (hamburgerBtn) hamburgerBtn.addEventListener('click', () => {
      sidebar.classList.toggle('open');
      hamburgerBtn.classList.toggle('open');
      overlay.classList.toggle('active');
    });

    if (overlay) overlay.addEventListener('click', () => {
      sidebar.classList.remove('open');
      hamburgerBtn.classList.remove('open');
      overlay.classList.remove('active');
    });

    if (userProfile) userProfile.addEventListener('click', (e) => {
      // Pour √©viter de fermer la dropdown en cliquant sur la fl√®che/avatar
      if (e.target.closest('#dropdownArrow') || e.target.closest('.avatar')) {
          profileDropdown.classList.toggle('active');
      }
    });

    document.addEventListener('click', (e) => {
      if (!userProfile.contains(e.target) && !profileDropdown.contains(e.target)) {
        profileDropdown.classList.remove('active');
      }
    });

    if (logoutBtn) logoutBtn.addEventListener('click', async () => {
      try {
        await auth.signOut();
        window.location.href = 'login.html';
      } catch (error) {
        console.error("Erreur de d√©connexion:", error);
        showNotification('error', 'D√©connexion', 'Une erreur s\'est produite lors de la d√©connexion.');
      }
    });

    // Toggle de th√®me (IDs CONSERV√âS)
    if (themeToggle) themeToggle.addEventListener('click', toggleTheme);
    if (themeToggleDropdown) themeToggleDropdown.addEventListener('click', toggleTheme);

    // Copie du lien de parrainage (IDs CONSERV√âS)
    if (copyKeyBtn) copyKeyBtn.addEventListener('click', () => {
      const link = referralLink.textContent;
      navigator.clipboard.writeText(link).then(() => {
        showNotification('success', 'Cl√© copi√©e', 'La cl√© d\'activation a √©t√© copi√©e dans votre presse-papiers !');
      }).catch(err => {
        console.error('Erreur de copie:', err);
        showNotification('error', 'Erreur', 'Impossible de copier la cl√©.');
      });
    });

    // Partage du lien de parrainage (IDs CONSERV√âS)
    if (sendKeyBtn) sendKeyBtn.addEventListener('click', () => {
      const link = referralLink.textContent;
      const message = `üëã Voici ma cl√© d'activation BLOWEARN AGENCIES : ${link}. Rejoins-moi et commence √† gagner ! üöÄ`;
      if (navigator.share) {
        navigator.share({
          title: 'Cl√© d\'activation BLOWEARN AGENCIES',
          text: message,
          url: link,
        }).catch((error) => console.log('Erreur de partage:', error));
      } else {
        // Fallback pour les navigateurs sans API Share
        window.open(`whatsapp://send?text=${encodeURIComponent(message)}`, '_blank');
      }
    });


    /******** Initialisation ********/
    auth.onAuthStateChanged(async (user) => {
      // CODE JS CONSERV√â
      currentUser = user;
      if (user) {
        try {
          await loadUserData();
          applyTheme(); // Appliquer le th√®me apr√®s le chargement des donn√©es

          updateUserInfoUI(user, userData);
          updateTransactionHistory();

          // Assurer que le lien de parrainage est l'URL compl√®te (ID 'referralLink' CONSERV√â)
          if (referralLink) {
            const userReferralId = userData.referralId || user.uid;
            referralLink.textContent = `${APP_DOMAIN}/index.html?ref=${encodeURIComponent(userReferralId)}`;
          }

          // D√©marrer le watcher qui d√©clenchera la r√©partition au moment o√π 'status' devient 'paid'
          startStatusWatcherAndTriggerProcessing();

          document.body.classList.add('loaded');
          if (loader) loader.classList.add('hidden');

          showNotification('success', 'Bienvenue !', `Content de vous revoir, ${userData.displayName || (user.email && user.email.split('@')[0])}!`);
        } catch (error) {
          console.error("Erreur critique lors de l'initialisation :", error);
          showNotification('error', 'Erreur Critique', "Impossible de charger vos donn√©es. Veuillez vous reconnecter.");
          auth.signOut();
          setTimeout(() => { window.location.href = 'login.html'; }, 3000);
        }
      } else {
        window.location.href = 'login.html';
      }
    });

    /******** Theme helper ********/
    function applyTheme() {
      // CODE JS CONSERV√â
      const isDarkMode = userData.theme === 'dark';
      document.body.classList.toggle('dark-mode', isDarkMode);
      if (themeToggle) themeToggle.innerHTML = isDarkMode 
          ? '<i class="fas fa-sun"></i>' 
          : '<i class="fas fa-moon"></i>';
      if (themeToggleDropdown) themeToggleDropdown.innerHTML = isDarkMode 
          ? '<i class="fas fa-sun"></i><span>Mode jour</span>' 
          : '<i class="fas fa-moon"></i><span>Mode nuit</span>';
    }

    /******** Initialisation ********/
    document.addEventListener('DOMContentLoaded', () => {
      updateCalendar();
    });

    /******** Expose quelques utilitaires pour debug dans console ********/
    window._mulaflowr = {
      requestReferralProcessing: async (uid) => {
        // CODE JS CONSERV√â
        if (!currentUser) return console.error('Utilisateur non connect√©');
        const idToken = await currentUser.getIdToken();
        const resp = await fetch(`${SERVER_URL}/api/process-referral-on-paid`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` },
          body: JSON.stringify({ userDocId: uid || currentUser.uid })
        });
        const json = await resp.json().catch(()=>({}));
        console.log('R√©sultat du for√ßage de traitement:', json);
        return json;
      },
      loadData: loadUserData,
      updateUI: () => { updateDashboardUI(); updateUserInfoUI(currentUser, userData); updateTransactionHistory(); }
    };

  </script>
</body>
</html>
