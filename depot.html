<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BLOWEARN AGENCIES - Depot</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --color-primary:#4A90E2;
      --color-secondary:#FFC107;
      --color-text-dark:#2C3E50;
      --color-text-light:#ECF0F1;
      --color-bg-gradient-1:#6DD5FA;
      --color-bg-gradient-2:#FF7582;
      --success-color:#4CD964;
      --danger-color:#FF3B30;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Montserrat',sans-serif}
    body{
      background: linear-gradient(135deg,var(--color-bg-gradient-1) 0%,var(--color-bg-gradient-2) 100%);
      color:var(--color-text-dark);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:20px;
    }
    .container{width:100%;max-width:500px;margin:0 auto}
    .card{
      background: rgba(255,255,255,0.95);
      border-radius:20px;
      padding:30px;
      box-shadow:0 20px 60px rgba(0,0,0,0.15);
      border:1px solid rgba(255,255,255,0.7);
    }
    .logo{
      font-size:2rem;
      font-weight:700;
      text-align:center;
      margin-bottom:10px;
      font-family:'Poppins',sans-serif;
      background:linear-gradient(45deg,var(--color-primary),var(--color-secondary));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .subtitle{text-align:center;color:#607d8b;margin-bottom:25px;font-size:0.95rem}
    h2{color:var(--color-text-dark);font-size:1.5rem;margin-bottom:20px;text-align:center}
    .user-info{
      background:rgba(74,144,226,0.1);
      padding:12px 15px;
      border-radius:10px;
      margin-bottom:20px;
      text-align:center;
    }
    .user-info span{color:#607d8b;font-size:0.9rem}
    .user-info strong{color:var(--color-primary);display:block;font-size:1.1rem;margin-top:3px}
    .form-group{margin-bottom:20px}
    .form-label{display:block;font-weight:600;margin-bottom:8px;color:var(--color-text-dark)}
    .form-input,.form-select{
      width:100%;
      padding:14px 16px;
      border-radius:12px;
      border:2px solid #e0e0e0;
      font-size:1rem;
      transition:all 0.3s;
      background:#fff;
    }
    .form-input:focus,.form-select:focus{
      outline:none;
      border-color:var(--color-primary);
      box-shadow:0 0 0 4px rgba(74,144,226,0.15);
    }
    .amount-presets{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px}
    .preset-btn{
      flex:1;
      min-width:80px;
      padding:12px 8px;
      border:2px solid #e0e0e0;
      border-radius:10px;
      background:#fff;
      cursor:pointer;
      font-weight:600;
      font-size:0.9rem;
      transition:all 0.3s;
    }
    .preset-btn:hover{border-color:var(--color-primary);background:rgba(74,144,226,0.05)}
    .preset-btn.selected{border-color:var(--color-primary);background:rgba(74,144,226,0.1);color:var(--color-primary)}
    .methods{display:flex;flex-direction:column;gap:10px;margin-bottom:20px}
    .method{
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px;
      border-radius:12px;
      border:2px solid #e0e0e0;
      background:#fff;
      cursor:pointer;
      transition:all 0.3s;
    }
    .method:hover{border-color:var(--color-primary);background:rgba(74,144,226,0.03)}
    .method.selected{border-color:var(--color-primary);background:rgba(74,144,226,0.1)}
    .method i{font-size:22px;color:var(--color-primary);width:30px;text-align:center}
    .method-info{flex:1}
    .method-name{font-weight:700;color:var(--color-text-dark)}
    .method-desc{font-size:0.85rem;color:#607d8b}
    .btn{
      display:block;
      width:100%;
      padding:16px;
      background:linear-gradient(135deg,var(--color-primary) 0%,#79C3F8 100%);
      color:white;
      border:none;
      border-radius:12px;
      font-size:1.1rem;
      font-weight:700;
      cursor:pointer;
      transition:all 0.3s;
    }
    .btn:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(74,144,226,0.4)}
    .btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}
    .btn.secondary{background:#f5f5f5;color:var(--color-text-dark);margin-top:10px}
    .btn.secondary:hover{background:#e8e8e8}
    .spinner{display:inline-block;width:18px;height:18px;border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite;margin-right:10px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .message{margin-top:15px;padding:12px;border-radius:10px;text-align:center}
    .message.error{background:rgba(255,59,48,0.1);border:1px solid rgba(255,59,48,0.3);color:#C62828}
    .message.success{background:rgba(76,205,100,0.1);border:1px solid rgba(76,205,100,0.3);color:#2E7D32}
    .message.info{background:rgba(74,144,226,0.1);border:1px solid rgba(74,144,226,0.3);color:#1565C0}
    .back-link{display:block;text-align:center;margin-top:20px;color:var(--color-primary);text-decoration:none;font-weight:500}
    .back-link:hover{text-decoration:underline}
    .min-info{font-size:0.85rem;color:#607d8b;text-align:center;margin-top:10px}
    @media (max-width:500px){.container{padding:10px}.card{padding:20px}.preset-btn{min-width:70px;font-size:0.8rem}}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="logo"><i class="fas fa-crown"></i> BLOWEARN</div>
      <p class="subtitle">Deposez de l'argent sur votre compte</p>
      
      <h2><i class="fas fa-wallet" style="color:var(--color-primary);margin-right:8px"></i>Faire un depot</h2>
      
      <div class="user-info">
        <span>Compte connecte :</span>
        <strong id="displayName">Chargement...</strong>
      </div>
      
      <div class="form-group">
        <label class="form-label">Montant a deposer (FCFA)</label>
        <div class="amount-presets">
          <button type="button" class="preset-btn" data-amount="1000">1 000</button>
          <button type="button" class="preset-btn" data-amount="2000">2 000</button>
          <button type="button" class="preset-btn" data-amount="5000">5 000</button>
          <button type="button" class="preset-btn" data-amount="10000">10 000</button>
        </div>
        <input type="number" id="amount" class="form-input" placeholder="Entrez un montant" min="500" data-testid="input-amount">
        <p class="min-info">Montant minimum : 500 FCFA</p>
      </div>
      
      <div class="form-group">
        <label class="form-label">Methode de paiement</label>
        <div class="methods">
          <div class="method" id="mobileMoneyMethod" data-testid="method-mobile-money">
            <i class="fas fa-mobile-screen-button"></i>
            <div class="method-info">
              <div class="method-name">Mobile Money</div>
              <div class="method-desc">MTN MoMo / Orange Money</div>
            </div>
          </div>
          <div class="method" id="cardMethod" data-testid="method-card">
            <i class="fas fa-credit-card"></i>
            <div class="method-info">
              <div class="method-name">Carte bancaire</div>
              <div class="method-desc">Visa / Mastercard</div>
            </div>
          </div>
        </div>
      </div>
      
      <button id="depositBtn" class="btn" data-testid="button-deposit">
        <i class="fas fa-arrow-up"></i> DEPOSER MAINTENANT
      </button>
      
      <button id="backBtn" class="btn secondary">
        <i class="fas fa-arrow-left"></i> Retour au tableau de bord
      </button>
      
      <div id="message"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCjGisjgbFc2ZE0BFgdhlUao8bCCeuKP1k",
      authDomain: "cash-flowr.firebaseapp.com",
      projectId: "cash-flowr",
      storageBucket: "cash-flowr.firebasestorage.app",
      messagingSenderId: "1091928501310",
      appId: "1:1091928501310:web:4f4de306cde36f378ff56f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const SERVER_URL = "https://mulaflowr-exaucenapopolo2.replit.app";

    const displayNameEl = document.getElementById('displayName');
    const amountInput = document.getElementById('amount');
    const messageEl = document.getElementById('message');
    const depositBtn = document.getElementById('depositBtn');
    const backBtn = document.getElementById('backBtn');
    const mobileMoneyMethod = document.getElementById('mobileMoneyMethod');
    const cardMethod = document.getElementById('cardMethod');
    const presetBtns = document.querySelectorAll('.preset-btn');

    let currentUser = null;
    let selectedMethod = null;
    let userCountryCode = 'CM';
    let isProcessing = false;

    function showMessage(text, type = 'info') {
      messageEl.innerHTML = `<div class="message ${type}">${text}</div>`;
    }

    function clearMessage() {
      messageEl.innerHTML = '';
    }

    function setLoading(loading) {
      isProcessing = loading;
      depositBtn.disabled = loading;
      if (loading) {
        depositBtn.innerHTML = '<span class="spinner"></span> Traitement...';
      } else {
        depositBtn.innerHTML = '<i class="fas fa-arrow-up"></i> DEPOSER MAINTENANT';
      }
    }

    presetBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        presetBtns.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        amountInput.value = btn.dataset.amount;
        clearMessage();
      });
    });

    amountInput.addEventListener('input', () => {
      presetBtns.forEach(b => b.classList.remove('selected'));
      clearMessage();
    });

    mobileMoneyMethod.addEventListener('click', () => {
      mobileMoneyMethod.classList.add('selected');
      cardMethod.classList.remove('selected');
      selectedMethod = 'mobile_money';
      clearMessage();
    });

    cardMethod.addEventListener('click', () => {
      cardMethod.classList.add('selected');
      mobileMoneyMethod.classList.remove('selected');
      selectedMethod = 'card';
      clearMessage();
    });

    backBtn.addEventListener('click', () => {
      window.location.href = 'dashboard.html';
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      currentUser = user;
      displayNameEl.textContent = user.displayName || user.email || user.uid;

      try {
        const userRef = doc(db, 'users', user.uid);
        const snap = await getDoc(userRef);
        if (snap.exists()) {
          const data = snap.data();
          if (data.country) userCountryCode = data.country.toUpperCase();
          if (data.displayName || data.username) {
            displayNameEl.textContent = data.displayName || data.username;
          }
        }
      } catch (err) {
        console.error('Erreur chargement donnees:', err);
      }
    });

    async function createDeposit({ userId, email, username, amount, currency, country, method }) {
      const idToken = currentUser ? await currentUser.getIdToken() : null;
      const payload = { userId, email, username, amount, currency, country, method, type: 'deposit' };
      const headers = { 'Content-Type': 'application/json' };
      if (idToken) headers['Authorization'] = `Bearer ${idToken}`;

      const resp = await fetch(`${SERVER_URL}/create-deposit`, {
        method: 'POST',
        headers,
        body: JSON.stringify(payload)
      });

      const data = await resp.json();
      if (!resp.ok) throw new Error(data.error || 'Erreur creation depot');
      return data;
    }

    async function confirmDeposit(transactionId) {
      try {
        const resp = await fetch(`${SERVER_URL}/confirm-deposit/${encodeURIComponent(transactionId)}`);
        if (!resp.ok) return null;
        return await resp.json();
      } catch (err) {
        console.error('Erreur confirmation:', err);
        return null;
      }
    }

    async function checkAndRedirect(transactionId) {
      const result = await confirmDeposit(transactionId);
      if (result && (result.isPaid === true || result.status === 'paid' || result.status === 'success')) {
        showMessage('Depot confirme ! Redirection vers votre tableau de bord...', 'success');
        localStorage.removeItem('blowearn_deposit_id');
        setTimeout(() => {
          window.location.href = 'dashboard.html';
        }, 1500);
        return true;
      }
      return false;
    }

    depositBtn.addEventListener('click', async () => {
      if (isProcessing) return;

      const amount = parseInt(amountInput.value);

      if (!amount || amount < 500) {
        showMessage('Veuillez entrer un montant minimum de 500 FCFA.', 'error');
        return;
      }

      if (!selectedMethod) {
        showMessage('Veuillez selectionner une methode de paiement.', 'error');
        return;
      }

      if (!currentUser) {
        window.location.href = 'login.html';
        return;
      }

      try {
        setLoading(true);
        showMessage('Creation de la session de depot...', 'info');

        const result = await createDeposit({
          userId: currentUser.uid,
          email: currentUser.email,
          username: currentUser.displayName || currentUser.email.split('@')[0],
          amount: amount,
          currency: 'XAF',
          country: userCountryCode,
          method: selectedMethod
        });

        if (!result || !result.ok) {
          throw new Error(result?.error || 'Erreur creation depot');
        }

        const checkoutUrl = result.checkoutUrl;
        const transactionId = result.transactionId;

        if (!checkoutUrl) {
          throw new Error('URL de paiement non recue');
        }

        if (transactionId) {
          localStorage.setItem('blowearn_deposit_id', transactionId);
        }

        showMessage('Redirection vers la page de paiement...', 'success');
        setTimeout(() => {
          window.location.href = checkoutUrl;
        }, 500);

      } catch (err) {
        console.error('Erreur depot:', err);
        showMessage('Erreur: ' + err.message, 'error');
        setLoading(false);
      }
    });

    (async function handleReturnFromProvider() {
      const params = new URLSearchParams(window.location.search);
      const transactionId = params.get('tx_id') || 
                            params.get('transaction_id') ||
                            params.get('transactionId') ||
                            localStorage.getItem('blowearn_deposit_id');
      
      if (!transactionId) return;

      showMessage('Verification du depot en cours...', 'info');
      setLoading(true);

      const isPaid = await checkAndRedirect(transactionId);
      
      if (!isPaid) {
        let attempts = 0;
        const maxAttempts = 10;
        
        const pollInterval = setInterval(async () => {
          attempts++;
          showMessage(`Verification du depot... (${attempts}/${maxAttempts})`, 'info');
          
          const paid = await checkAndRedirect(transactionId);
          
          if (paid || attempts >= maxAttempts) {
            clearInterval(pollInterval);
            setLoading(false);
            
            if (!paid) {
              showMessage('Le depot est en cours de traitement. Vous pouvez retourner au tableau de bord.', 'info');
            }
          }
        }, 2000);
      }
    })();

    let backgroundCheckInterval = null;
    function startBackgroundCheck() {
      const transactionId = localStorage.getItem('blowearn_deposit_id');
      if (!transactionId || backgroundCheckInterval) return;
      
      backgroundCheckInterval = setInterval(async () => {
        const result = await confirmDeposit(transactionId);
        if (result && (result.isPaid === true || result.status === 'paid' || result.status === 'success')) {
          clearInterval(backgroundCheckInterval);
          localStorage.removeItem('blowearn_deposit_id');
          showMessage('Depot confirme ! Redirection...', 'success');
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 1500);
        }
      }, 5000);
    }
    
    setTimeout(startBackgroundCheck, 2000);
  </script>
</body>
</html>